<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Nomad Job Manifests - The Standard Documentation</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Tutorials</li><li class="chapter-item expanded "><a href="../../tutorials/walk-in-the-park.html"><strong aria-hidden="true">1.</strong> A walk in the park</a></li><li class="chapter-item expanded "><a href="../../tutorials/hello-world/index.html"><strong aria-hidden="true">2.</strong> Hello World</a></li><li class="chapter-item expanded "><a href="../../tutorials/hello-moon/index.html"><strong aria-hidden="true">3.</strong> Hello Moon</a></li><li class="chapter-item expanded affix "><li class="part-title">How-To Guides</li><li class="chapter-item expanded "><a href="../../guides/growing-cells.html"><strong aria-hidden="true">4.</strong> Growing Cells</a></li><li class="chapter-item expanded "><a href="../../guides/incl.html"><strong aria-hidden="true">5.</strong> Include Filter</a></li><li class="chapter-item expanded "><a href="../../guides/envrc.html"><strong aria-hidden="true">6.</strong> Setup .envrc</a></li><li class="chapter-item expanded affix "><li class="part-title">Explanation</li><li class="chapter-item expanded "><a href="../../explain/why-nix.html"><strong aria-hidden="true">7.</strong> Why nix?</a></li><li class="chapter-item expanded "><a href="../../explain/why-std.html"><strong aria-hidden="true">8.</strong> Why std?</a></li><li class="chapter-item expanded "><a href="../../explain/architecture-decision-records/index.html"><strong aria-hidden="true">9.</strong> Architecture Decisions</a></li><li class="chapter-item expanded affix "><li class="part-title">Patterns</li><li class="chapter-item expanded "><a href="../../patterns/four-packaging-layers.html"><strong aria-hidden="true">10.</strong> The 4 Packaging Layers</a></li><li class="chapter-item expanded affix "><li class="part-title">Templates</li><li class="chapter-item expanded "><a href="../../templates/rust.html"><strong aria-hidden="true">11.</strong> Rust</a></li><li class="chapter-item expanded affix "><li class="part-title">Reference</li><li class="chapter-item expanded "><a href="../../reference/cli.html"><strong aria-hidden="true">12.</strong> TUI/CLI</a></li><li class="chapter-item expanded "><a href="../../reference/conventions.html"><strong aria-hidden="true">13.</strong> Conventions</a></li><li class="chapter-item expanded "><a href="../../reference/deprecations.html"><strong aria-hidden="true">14.</strong> Deprecations</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes.html"><strong aria-hidden="true">15.</strong> Builtin Block Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/blocktypes/data-blocktype.html"><strong aria-hidden="true">15.1.</strong> Data</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/functions-blocktype.html"><strong aria-hidden="true">15.2.</strong> Functions</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/runnables-blocktype.html"><strong aria-hidden="true">15.3.</strong> Runnables</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/installables-blocktype.html"><strong aria-hidden="true">15.4.</strong> Installables</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/microvms-blocktype.html"><strong aria-hidden="true">15.5.</strong> Microvms</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/devshells-blocktype.html"><strong aria-hidden="true">15.6.</strong> Devshells</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/containers-blocktype.html"><strong aria-hidden="true">15.7.</strong> Containers</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/nixago-blocktype.html"><strong aria-hidden="true">15.8.</strong> Nixago</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/arion-blocktype.html"><strong aria-hidden="true">15.9.</strong> Arion</a></li><li class="chapter-item expanded "><a href="../../reference/blocktypes/nomad-job-manifests-blocktype.html" class="active"><strong aria-hidden="true">15.10.</strong> Nomad Job Manifests</a></li></ol></li><li class="chapter-item expanded "><a href="../../reference/std/index.html"><strong aria-hidden="true">16.</strong> //std</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/std/cli/index.html"><strong aria-hidden="true">16.1.</strong> /cli</a></li><li class="chapter-item expanded "><a href="../../reference/std/devshellProfiles/index.html"><strong aria-hidden="true">16.2.</strong> /devshellProfiles</a></li><li class="chapter-item expanded "><a href="../../reference/std/nixago/index.html"><strong aria-hidden="true">16.3.</strong> /nixago</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/std/nixago/adrgen.html"><strong aria-hidden="true">16.3.1.</strong> /adrgen</a></li><li class="chapter-item expanded "><a href="../../reference/std/nixago/conform.html"><strong aria-hidden="true">16.3.2.</strong> /conform</a></li><li class="chapter-item expanded "><a href="../../reference/std/nixago/editorconfig.html"><strong aria-hidden="true">16.3.3.</strong> /editorconfig</a></li><li class="chapter-item expanded "><a href="../../reference/std/nixago/just.html"><strong aria-hidden="true">16.3.4.</strong> /just</a></li><li class="chapter-item expanded "><a href="../../reference/std/nixago/lefthook.html"><strong aria-hidden="true">16.3.5.</strong> /lefthook</a></li><li class="chapter-item expanded "><a href="../../reference/std/nixago/mdbook.html"><strong aria-hidden="true">16.3.6.</strong> /mdbook</a></li><li class="chapter-item expanded "><a href="../../reference/std/nixago/treefmt.html"><strong aria-hidden="true">16.3.7.</strong> /treefmt</a></li><li class="chapter-item expanded "><a href="../../reference/std/nixago/githubsettings.html"><strong aria-hidden="true">16.3.8.</strong> /githubsettings</a></li></ol></li><li class="chapter-item expanded "><a href="../../reference/std/errors/index.html"><strong aria-hidden="true">16.4.</strong> /errors</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/std/errors/removeBy.html"><strong aria-hidden="true">16.4.1.</strong> /removeBy</a></li><li class="chapter-item expanded "><a href="../../reference/std/errors/requireInput.html"><strong aria-hidden="true">16.4.2.</strong> /requireInput</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../reference/lib/index.html"><strong aria-hidden="true">17.</strong> //lib</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/lib/dev/index.html"><strong aria-hidden="true">17.1.</strong> /dev</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/lib/dev/mkMakes.html"><strong aria-hidden="true">17.1.1.</strong> /mkMakes</a></li><li class="chapter-item expanded "><a href="../../reference/lib/dev/mkShell.html"><strong aria-hidden="true">17.1.2.</strong> /mkShell</a></li><li class="chapter-item expanded "><a href="../../reference/lib/dev/mkNixago.html"><strong aria-hidden="true">17.1.3.</strong> /mkNixago</a></li><li class="chapter-item expanded "><a href="../../reference/lib/dev/mkArion.html"><strong aria-hidden="true">17.1.4.</strong> /mkArion</a></li></ol></li><li class="chapter-item expanded "><a href="../../reference/lib/ops/index.html"><strong aria-hidden="true">17.2.</strong> /ops</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/lib/ops/mkMicrovm.html"><strong aria-hidden="true">17.2.1.</strong> /mkMicrovm</a></li><li class="chapter-item expanded "><a href="../../reference/lib/ops/mkOperable.html"><strong aria-hidden="true">17.2.2.</strong> /mkOperable</a></li><li class="chapter-item expanded "><a href="../../reference/lib/ops/mkOCI.html"><strong aria-hidden="true">17.2.3.</strong> /mkOCI</a></li><li class="chapter-item expanded "><a href="../../reference/lib/ops/mkStandardOCI.html"><strong aria-hidden="true">17.2.4.</strong> /mkStandardOCI</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../reference/presets/index.html"><strong aria-hidden="true">18.</strong> //presets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/presets/templates/index.html"><strong aria-hidden="true">18.1.</strong> /templates</a></li><li class="chapter-item expanded "><a href="../../reference/presets/nixago/index.html"><strong aria-hidden="true">18.2.</strong> /nixago</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/presets/nixago/adrgen.html"><strong aria-hidden="true">18.2.1.</strong> /adrgen</a></li><li class="chapter-item expanded "><a href="../../reference/presets/nixago/conform.html"><strong aria-hidden="true">18.2.2.</strong> /conform</a></li><li class="chapter-item expanded "><a href="../../reference/presets/nixago/editorconfig.html"><strong aria-hidden="true">18.2.3.</strong> /editorconfig</a></li><li class="chapter-item expanded "><a href="../../reference/presets/nixago/lefthook.html"><strong aria-hidden="true">18.2.4.</strong> /lefthook</a></li><li class="chapter-item expanded "><a href="../../reference/presets/nixago/mdbook.html"><strong aria-hidden="true">18.2.5.</strong> /mdbook</a></li><li class="chapter-item expanded "><a href="../../reference/presets/nixago/treefmt.html"><strong aria-hidden="true">18.2.6.</strong> /treefmt</a></li><li class="chapter-item expanded "><a href="../../reference/presets/nixago/githubsettings.html"><strong aria-hidden="true">18.2.7.</strong> /githubsettings</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> //_automation</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../reference/_automation/devshells/index.html"><strong aria-hidden="true">19.1.</strong> /devshells</a></li></ol></li><li class="chapter-item expanded "><a href="../../glossary.html"><strong aria-hidden="true">20.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Standard Documentation</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="nomad-job-manfiests"><a class="header" href="#nomad-job-manfiests">Nomad Job Manfiests</a></h1>
<pre><code class="language-nix">{
  nixpkgs,
  mkCommand,
}: let
  l = nixpkgs.lib // builtins;
  /*
  Use the `nomadJobsManifest` Blocktype for rendering job descriptions
  for the Nomad Cluster scheduler. Each named attribtute-set under the
  block contains a valid Nomad job description, written in Nix.

  Available actions:
    - render
    - deploy
    - explore
  */
  nomadJobManifests = name: {
    __functor = import ./__functor.nix;
    inherit name;
    type = &quot;nomadJobManifests&quot;;

    actions = {
      system,
      fragment,
      fragmentRelPath,
      target,
    }: let
      fx = &quot;${nixpkgs.legacyPackages.${system}.fx}/bin&quot;;
      nomad = &quot;${nixpkgs.legacyPackages.${system}.nomad}/bin&quot;;
      jq = &quot;${nixpkgs.legacyPackages.${system}.jq}/bin&quot;;
      job = baseNameOf fragmentRelPath;
      nixExpr = ''
        x: let
          job = builtins.mapAttrs (_: v: v // {meta = v.meta or {} // {rev = &quot;\&quot;$(git rev-parse --short HEAD)\&quot;&quot;;};}) x.job;
        in
          builtins.toFile \&quot;${job}.json\&quot; (builtins.unsafeDiscardStringContext (builtins.toJSON {inherit job;}))
      '';
      layout = ''
        if test -z &quot;$PRJ_ROOT&quot;; then
          echo &quot;PRJ_ROOT is not set. Action aborting.&quot;
          exit 1
        fi
        if test -z &quot;$PRJ_DATA_DIR&quot;; then
          echo &quot;PRJ_DATA_DIR is not set. Action aborting.&quot;
          exit 1
        fi
        job_path=&quot;$PRJ_DATA_DIR/${dirOf fragmentRelPath}/${job}.json&quot;

        # use Nomad bin in path if it exists, and only fallback on nixpkgs if it doesn't
        PATH=&quot;$PATH:${nomad}&quot;
      '';
      render = ''
        if test -z &quot;$PRJ_ROOT&quot;; then
          echo &quot;PRJ_ROOT is not set. Action aborting.&quot;
          exit 1
        fi

        echo &quot;Rendering to $job_path...&quot;

        # use `PRJ_ROOT` to capture dirty state
        if ! out=&quot;$(nix eval --no-allow-dirty --raw $PRJ_ROOT\#${fragment} --apply &quot;${nixExpr}&quot;)&quot;; then
          &gt;&amp;2 echo &quot;error: Will not render jobs from a dirty tree, otherwise we cannot keep good track of deployment history.&quot;
          exit 1
        fi

        nix build &quot;$out&quot; --out-link &quot;$job_path&quot; 2&gt;/dev/null

        if status=$(nomad validate &quot;$job_path&quot;); then
          echo &quot;$status for $job_path&quot;
        fi
      '';
    in [
      /*
      The `render` action will take this Nix job descrition, convert it to JSON,
      inject the git revision validate the manifest, after which it can be run or
      planned with the Nomad cli or the `deploy` action.
      */
      (mkCommand system {
        name = &quot;render&quot;;
        description = &quot;build the JSON job description&quot;;
        command =
          # bash
          ''
            set -e

            ${layout}

            ${render}
          '';
      })
      (mkCommand system {
        name = &quot;deploy&quot;;
        description = &quot;Deploy the job to Nomad&quot;;
        command =
          # bash
          ''
            set -e

            ${layout}

            PATH=$PATH:${jq}

            if ! [[ -h &quot;$job_path&quot; ]] \
              || [[ &quot;$(jq -r '.job[].meta.rev' &quot;$job_path&quot;)&quot; != &quot;$(git rev-parse --short HEAD)&quot; ]]
            then ${render}
            fi

            if ! plan_results=$(nomad plan -force-color &quot;$job_path&quot;); then
              echo &quot;$plan_results&quot;

              cmd=&quot;$(echo &quot;$plan_results&quot; | grep 'nomad job run -check-index')&quot;

              # prompt user interactiely except in CI
              if ! [[ -v CI ]]; then
                read -rp &quot;Deploy this job? (y/N)&quot; deploy

                case &quot;$deploy&quot; in
                [Yy])
                  eval &quot;$cmd&quot;
                  ;;
                *)
                  echo &quot;Exiting without deploying&quot;
                  ;;
                esac
              else
                eval &quot;$cmd&quot;
              fi
            else
              echo &quot;Job hasn't changed since last deployment, nothing to deploy&quot;
            fi
          '';
      })
      (mkCommand system {
        name = &quot;explore&quot;;
        description = &quot;interactively explore the Job defintion&quot;;
        command =
          # bash
          ''
            set -e

            ${layout}

            if ! [[ -h &quot;$job_path&quot; ]]; then
            ${render}
            fi

            PATH=$PATH:${fx}

            fx &quot;$job_path&quot;
          '';
      })
    ];
  };
in
  nomadJobManifests
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../reference/blocktypes/arion-blocktype.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../reference/std/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../reference/blocktypes/arion-blocktype.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../reference/std/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../static/mermaid.min.js"></script>
        <script type="text/javascript" src="../../static/mermaid-init.js"></script>
    </body>
</html>
